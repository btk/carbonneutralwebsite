import Head from 'next/head'
import Image from 'next/image'
import Link from 'next/link'
import styles from '../styles/Home.module.css'
import Header from '../components/Header'
import Footer from '../components/Footer'
import Logo from '../components/Logo'
import post from '../js/post'
import get from '../js/get'
import { useState, useEffect } from 'react'
import { Button, Text, Container, Card, Row, Spacer, Collapse, Navbar, Dropdown, Avatar, Input } from '@nextui-org/react';

const CARBON_PER_KB = 0.000845703125; // g
const TREE_EMISSON_PER_YEAR = 24000.00;// g
const CARBON_PER_PAGE_LOAD_ON_DEVICE = 0.002183706; // g
const OVERALL_LIGHTHOUSE_SCORE_EFFECT = 20; // out of 100

export default function Home() {
  const [url, setUrl] = useState("");
  const [pageView, setPageView] = useState(10000);
  const [ratio, setRatio] = useState(40);
  const [calculating, setCalculating] = useState(false);
  const [results, setResults] = useState({});
  const [pageSize, setPageSize] = useState({});
  const [footPrint, setFootPrint] = useState({});
  const [hostData, setHostData] = useState(null);

  let calculate = async () => {
    setCalculating(true);
    setHostData(null);
    setResults({});
    setFootPrint({});
    fetchHostData();

    const env = process.env.NODE_ENV
    let calculation
    if(env == "development" && url == ""){
      calculation = await get("/test.json");
    }else{
      calculation = await post("/api/calculate", {url})
    }

    let pageSizeInKb = calculatePageSize(calculation.audits["network-requests"].details.items);
    console.log(pageSizeInKb);
    setPageSize(pageSizeInKb);
    setResults(calculation);

    let calculatedFootPrint = calculateCarbonFootPrint(pageSizeInKb, calculation.score);
    setFootPrint(calculatedFootPrint);
    console.log("footPrint", calculatedFootPrint);
    setCalculating(false);
  }

  let fetchHostData = async () => {
    let fetchedHostData = await post("/api/location", {url});
    setHostData(fetchedHostData);
  }

  let calculatePageSize = (items) => {
    let totalInByte = 0;
    let totalInByteWithoutStatic = 0;
    items.forEach((item, i) => {
      if(item.finished){
        totalInByte += item.transferSize;
        if(item.resourceType == "Document" || item.resourceType == "Script" || item.resourceType == "Other"){
          totalInByteWithoutStatic += item.transferSize;
        }
      }
    });

    return {firstVisit: totalInByte / 1000, returningVisit: totalInByteWithoutStatic / 1000};
  }

  let calculateCarbonFootPrint = (pageSizeInKb, performanceScore) => {
    let performancePunishment = 1 + (1-performanceScore/100) / OVERALL_LIGHTHOUSE_SCORE_EFFECT;
    console.log("performancePunishment", performancePunishment);
    let firstVisitImpactKb = pageSizeInKb.firstVisit * performancePunishment;
    let returningVisitImpactKb = pageSizeInKb.returningVisit * performancePunishment;


    let firstVisitCarbon = firstVisitImpactKb * CARBON_PER_KB;
    let returningVisitCarbon = returningVisitImpactKb * CARBON_PER_KB;
    let totalImpactInCarbon = firstVisitCarbon * pageView * ratio + returningVisitCarbon * pageView * (100 - ratio);

    return {
      sizeInKb: {firstVisit: pageSizeInKb.firstVisit, returningVisit: pageSizeInKb.returningVisit},
      impactInKb: {firstVisit: firstVisitImpactKb, returningVisit: returningVisitImpactKb},
      impactInCarbon: {firstVisit: firstVisitCarbon, returningVisit: returningVisitCarbon},
      totalImpactInCarbon: totalImpactInCarbon,
      treeToOffset: totalImpactInCarbon / TREE_EMISSON_PER_YEAR + pageView * CARBON_PER_PAGE_LOAD_ON_DEVICE / TREE_EMISSON_PER_YEAR,
    };
  }

  return (
    <div className={styles.container}>
      <Head>
        <title>Carbon Neutral Website</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div className={styles.hero}>


        <div className={styles.heroContent}>
        <Logo />
        <>
          <Text
            h2
            size={31}
            weight="bold"
          >
            Calculate Your Website&apos;s
          </Text>
          <Text
            h2
            size={31}
            weight="bold"
          >
            Carbon Footprint
          </Text>
      </>
          <Input labelLeft="https://" size="lg" label="Page URL" placeholder="www.site.com" type="text" onChange={(e) => setUrl(e.target.value)}/>
          <Spacer y={0.6} />
          <Input size="lg" label="Yearly Pageview" placeholder="10000" type="number" value={pageView} onChange={(e) => setPageView(e.target.value)}/>
          <Spacer y={1.6} />
          <p>New PageView Ratio: <input type="range" value={ratio} min="1" max="100" onChange={(e) => setRatio(e.target.value)}/> {ratio}%<  /p>
          {!calculating && <Button size="lg" onClick={() => calculate()} color="gradient" auto>Calculate</Button>}
          {calculating && <div style={{color: "blue"}}>Calculating...</div>}
          {footPrint.impactInCarbon &&
            <div>
              <p>Performance Score: <b>{results.score} / 100</b></p>
              <p></p>
              <p>FirstVisit Load Kb: {footPrint.sizeInKb.firstVisit} kB</p>
              <p>ReturningVisit Load Kb: {footPrint.sizeInKb.returningVisit} kB</p>
              <p></p>

              <p>FirstVisit Natural Impact Kb: {footPrint.impactInKb.firstVisit} kB</p>
              <p>ReturningVisit Natural Impact Kb: {footPrint.impactInKb.returningVisit} kB</p>
              <p></p>

              <p>FirstVisit Carbon Footprint: {footPrint.impactInCarbon.firstVisit} g</p>
              <p>ReturningVisit Carbon Footprint: {footPrint.impactInCarbon.returningVisit} g</p>
              <p></p>

              <p>Total Impact in Carbon: {footPrint.totalImpactInCarbon / 1000} kg/yr</p>
              <p><big>Tree to offset: <b>{Math.ceil(footPrint.treeToOffset)} Trees</b></big></p>
            </div>
          }

          {hostData != null &&
            <div>
              <p>{hostData.city} {hostData.country}, {hostData.countryCode}</p>
              <p>ISP: {hostData.isp}</p>
            </div>
          }
        </div>
      </div>

      <Container>
       <Spacer y={1} />

        <Card css={{ $$cardColor: '$colors$gray900' }}>
          <Card.Body>
            <Row justify="center" align="center">
              <Text h6 size={15} color="white" css={{ m: 0, textAlign: "center" }}>
                Carbon Neutral Website is a carbon emission calculator that will take into account the power consumption of the devices used to access web pages and web servers, as well as the carbon footprint of the internet infrastructure. This calculator will also tell you the amount of trees you should plant to offset your website's carbon footprint.
              </Text>
            </Row>
          </Card.Body>

        </Card>


        <Collapse.Group>
          <Collapse title="How does it work?">
            <Text>
              The user inputs their domain name into the calculator and the web application will generate a report on the carbon emission of the website depending on the data transfer size and website efficiency. The report will include a set of recommendations on how to reduce the carbon footprint of the website.This calculator will also tell you the amount of trees you should plant to offset your website's carbon footprint.
            </Text>
          </Collapse>
          <Collapse title="Calculations">
            <Text style={{marginBottom: 10}}>
            Depending on data from <a href="https://carbonfund.org/calculation-methods/" target="_blank">CarbonFund</a> taking the average CO2 per kilowatt hour of <b>0.371 kg per kWh</b> (this value will be changed depending on the country of origin of the users and servers)
            </Text><Text style={{marginBottom: 10}}>
            Depending on the research by <a href="https://www.encon.eu/en" target="_blank">ENCON EU</a>,
            </Text><Text style={{marginBottom: 10}}>
            In summary, it can be concluded that the annual CO2 offsetting rate varies from <b>21.77 kg CO2/tree to 31.5 kg CO2/tree</b>. To compensate for 1 tonne of CO2, 31 to 46 trees are needed. In Europe, there are 300 to 500 trees per hectare. For calculating the figures on the Encon website, we assume a rate of 24 kg CO2/tree and an average of 500 trees per hectare. This means that 1 hectare of forest: 500 trees x 24 kg CO2/tree = 12,000 kg of CO2 offsets, i.e. 12 tonnes CO2/hectare.
            </Text><Text style={{marginBottom: 10}}>
            As an average, this application will assume one tree annual CO2 offsetting rate as <b>24 kg</b>.
            </Text><Text style={{marginBottom: 10}}>
            Carbon emission per kb downloaded;
            </Text><Text style={{marginBottom: 10}}>
            In a 2021 published <a href="https://observablehq.com/@mrchrisadams/carbon-footprint-of-sending-data-around" target="_blank">visual calculation notebook by Chris Adams</a> with energy consumption numbers taken from <a href="https://theshiftproject.org/en/lean-ict-2/" target="_blank">Shift Project's Lean ICT report</a> concludes that downloading 1 mb of data on average emits 0.866 g of CO2. Note that this number is only the transfer of data between servers, CDNs and user devices, and does not include the user device’s energy consumption to consume this data in terms of consuming content and scrolling through a website.
            </Text><Text style={{marginBottom: 10}}>
            Since our calculations will be in kb, we will accept the kB data transfer as <b>0.866/1024 = 0.000845703125 g CO2 per kb</b>.
            </Text><Text style={{marginBottom: 10}}>
            Carbon emission during Web browsing per minute;
            </Text><Text style={{marginBottom: 10}}>
            Depending on a paper called <a href="https://www.researchgate.net/publication/215697458_An_Analysis_of_Power_Consumption_in_a_Smartphone" target="_blank">An Analysis of Power Consumption in a Smartphone</a> in the section about Web Browsing;
            </Text><Text style={{marginBottom: 10}}>
            Web browsing average power over WiFi and GPRS. Aggregate power consumption is 352.8 mW for WiFi, and 429.0 mW for GPRS, excluding backlight 410.2 mW. The benchmark was trace-based, and ran for a total of 490 seconds.
            </Text><Text style={{marginBottom: 10}}>
            If we accept that half of users will use WiFi and other half celular, in total an average smart device would consume ((352.8 + 429.0) / 2 + 410.2) / (490/60) = <b>98.1 mW of energy per minute</b>.
            </Text><Text style={{marginBottom: 10}}>
            Since most of the energy consumption happens during the page load and idle browsing of a website does not consume as significant of an energy as data transfer energy consumption. We will accept the average session duration as one minute and won’t give an option to the user of the tool to change it. 98.1 mW of energy per page load on a device.
            </Text><Text style={{marginBottom: 10}}>
            In conclusion, 0.371 * (98.1 / 1000000) = <b>0.002183706 g CO2 emitted per page load and browse</b>.
            </Text>
          </Collapse>
          <Collapse title="Option C">
            <Text>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad
              minim veniam, quis nostrud exercitation ullamco laboris nisi ut
              aliquip ex ea commodo consequat.
            </Text>
          </Collapse>
        </Collapse.Group>

       </Container>
       <Footer/>
    </div>
  )
}
